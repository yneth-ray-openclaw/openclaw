services:
  security-suricata:
    build: ./suricata
    container_name: security-suricata
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    volumes:
      - ./suricata/etc:/etc/suricata:ro
      - ./suricata/rules:/var/lib/suricata/rules:ro
      - ./suricata/logs:/var/log/suricata
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  security-tracee:
    image: aquasec/tracee:latest
    container_name: security-tracee
    privileged: true
    pid: host
    volumes:
      - /etc/os-release:/etc/os-release:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./tracee/policies:/tracee/policies:ro
      - /tmp/tracee:/tmp/tracee
    command:
      - --containers
      - --output=json
      - --output=option:parse-arguments
      - --policy=/tracee/policies/openclaw.yaml
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  security-llm-proxy:
    build: ./llm-proxy
    container_name: security-llm-proxy
    env_file: .env.security
    networks:
      - security-net
      - openclaw_net
    ports:
      - "${SECURITY_LLM_PROXY_PORT:-18790}:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  security-api-proxy:
    build: ./api-proxy
    container_name: security-api-proxy
    env_file: .env.security
    networks:
      - security-net
      - openclaw_net
    ports:
      - "${SECURITY_API_PROXY_PORT:-18780}:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  security-alerter:
    image: alpine:3.19
    container_name: security-alerter
    env_file: .env.security
    volumes:
      - ./alerter/alert.sh:/alert.sh:ro
      - ./suricata/logs:/var/log/suricata:ro
      - /tmp/tracee:/tmp/tracee:ro
    entrypoint: ["sh", "/alert.sh"]
    depends_on:
      - security-suricata
      - security-tracee
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  security-net:
    driver: bridge
  openclaw_net:
    external: true
