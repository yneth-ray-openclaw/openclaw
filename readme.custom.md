# OpenClaw — Custom Setup Guide

This guide covers how to deploy OpenClaw with our security hardening and infrastructure customizations on a Linux host.

## Prerequisites

- Linux host (kernel 5.4+ with eBPF support)
- Docker Engine 20.10+
- Docker Compose v2
- `git`, `pnpm` (if building locally)
- A Telegram bot (for security alerts) — optional but recommended

## Quick Start

```bash
git clone <repo-url> openclaw && cd openclaw

# 1. Build and start OpenClaw
bash docker-setup.sh

# 2. Start the security stack
cd security && ./setup.sh
```

That's it. The rest of this document explains what each piece does and how to configure it.

---

## Step 1 — OpenClaw Core

### Build the Docker Image

`docker-setup.sh` handles everything: prerequisite checks, token generation, image building, and onboarding. It creates a `.env` file with a random `OPENCLAW_GATEWAY_TOKEN`.

To include extra system packages (Chromium, ffmpeg, tesseract, etc.) in the image:

```bash
export OPENCLAW_DOCKER_APT_PACKAGES="chromium ffmpeg imagemagick tesseract-ocr jq sqlite3 ripgrep python3-pip"
bash docker-setup.sh
```

The full list we use is in `.env.security.example` under `OPENCLAW_DOCKER_APT_PACKAGES`.

### Configure Environment

Copy and edit the env file:

```bash
cp .env.example .env
```

Set at minimum:

- `OPENCLAW_GATEWAY_TOKEN` — auto-generated by `docker-setup.sh`
- At least one model provider key (`ANTHROPIC_API_KEY`, `OPENAI_API_KEY`, etc.)
- Channel tokens for whichever channels you enable (`TELEGRAM_BOT_TOKEN`, `DISCORD_BOT_TOKEN`, etc.)

Env precedence (highest to lowest): process env > `./.env` > `~/.openclaw/.env` > `openclaw.json` env block.

### Start OpenClaw

```bash
docker compose up -d openclaw-gateway
```

The gateway binds to `0.0.0.0:18789` by default. Override with `OPENCLAW_GATEWAY_BIND=loopback` to restrict to localhost.

### Container Hardening (Built In)

The `docker-compose.yml` applies these automatically:

| Protection              | How                                                                                       |
| ----------------------- | ----------------------------------------------------------------------------------------- |
| Read-only filesystem    | `read_only: true` + `tmpfs: /tmp`                                                         |
| No privilege escalation | `no-new-privileges:true`                                                                  |
| Seccomp profile         | `security/seccomp/openclaw.json` — blocks ptrace, memory injection, kernel module loading |
| Config immutability     | Config dir mounted read-only (`:ro`); changes go through GitHub PRs                       |
| Non-root user           | Runs as `node` (uid 1000)                                                                 |

### Config Changes via Pull Requests

In Docker, `OPENCLAW_CONFIG_MODE=pr` (the default). Direct writes to `.openclaw` config files are blocked. Instead, config changes create a GitHub Pull Request automatically, giving you an audit trail and review step before any config takes effect.

---

## Step 2 — Security Stack

The security stack runs alongside OpenClaw as a separate Docker Compose project. It provides network IPS, runtime enforcement, API proxying (to hide secrets), and alerting — without modifying any upstream OpenClaw code.

### Architecture

```
                     Internet
                        |
                +-------+-------+
                |   docker0     |
                +---+-------+---+
                    |       |
       +------------+       +------------+
       |                                 |
  openclaw-gateway              openclaw-cli
       |                                 |
       |         openclaw_net           |
       +------+--------+--------------+
              |        |
 +------------+--+  +--+---------------+
 | LLM Proxy     |  | API Proxy        |
 | (FastAPI)     |  | (nginx+njs)      |
 | :8080 -> LLM  |  | :8081 Telegram   |
 | guard hooks   |  | :8082 Brave      |
 | streaming     |  | :8083 GitHub API |
 +---------------+  | :8084 GitHub Git |
                    | :8085 Google API |
                    | :8086 Viber API  |
                    +------------------+

 Suricata IPS ←── inline NFQUEUE on FORWARD chain, drops malicious packets
 Tracee      ←── eBPF enforcement, SIGKILL on critical violations
 Alerter     ←── tails logs, sends alerts + daily summary to Telegram
```

### Configure Credentials

```bash
cd security
cp .env.security.example .env.security
```

Edit `.env.security` and fill in:

| Variable                                | Required    | Purpose                                                    |
| --------------------------------------- | ----------- | ---------------------------------------------------------- |
| `TELEGRAM_BOT_TOKEN`                    | Recommended | Telegram alerts                                            |
| `TELEGRAM_CHAT_ID`                      | Recommended | Alert destination                                          |
| `LLM_API_KEY`                           | Yes         | Real Anthropic/OpenAI key (hidden from OpenClaw)           |
| `LLM_API_BASE`                          | Yes         | `https://api.anthropic.com` or `https://api.openai.com/v1` |
| `LLM_API_PROVIDER`                      | Yes         | `anthropic` or `openai`                                    |
| `BRAVE_API_KEY`                         | Optional    | Brave Search                                               |
| `GITHUB_TOKEN`                          | Optional    | GitHub API + Git                                           |
| `GOOGLE_CLIENT_ID/SECRET/REFRESH_TOKEN` | Optional    | Google Calendar/Gmail/Drive                                |
| `VIBER_BOT_TOKEN`                       | Optional    | Viber                                                      |

### Start the Security Stack

The interactive setup handles everything:

```bash
./setup.sh
```

Or manually:

```bash
# Setup Suricata rules
bash suricata/setup.sh

# Start all services
docker compose -f docker-compose.security.yml up -d
```

**Important:** OpenClaw must be started first so the `openclaw_net` Docker network exists.

### Wire OpenClaw to Use the Proxies

Two files need changes: `.env` for the proxy URLs, and `openclaw.json` to reference them.

**1. Add proxy URLs to `.env`:**

```bash
# LLM API — through the FastAPI proxy
LLM_PROXY_URL=http://security-llm-proxy:8080

# Telegram — through the nginx proxy
TELEGRAM_API_BASE_URL=http://security-api-proxy:8081

# Brave Search — through the nginx proxy
BRAVE_SEARCH_BASE_URL=http://security-api-proxy:8082/res/v1/web/search
```

**2. Reference them in `openclaw.json`** (uses `${VAR}` substitution):

```json
{
  "models": {
    "providers": {
      "anthropic": {
        "baseUrl": "${LLM_PROXY_URL}",
        "apiKey": "unused",
        "models": [{ "id": "claude-sonnet-4-5-20250929" }]
      }
    }
  },
  "channels": {
    "telegram": {
      "botToken": "proxied",
      "network": {
        "apiBaseUrl": "${TELEGRAM_API_BASE_URL}"
      }
    }
  },
  "tools": {
    "web": {
      "search": {
        "brave": {
          "baseUrl": "${BRAVE_SEARCH_BASE_URL}"
        }
      }
    }
  }
}
```

The proxies inject real API keys at request time — OpenClaw never sees them.

**Note:** GitHub, Google, and Viber proxies work at the network level (Suricata/iptables) and don't have application-level base URL overrides yet.

---

## What the Security Stack Does

### Network IPS (Suricata)

Suricata runs inline on the FORWARD chain via NFQUEUE. All container traffic passes through it.

**Threat feeds enabled:**

- ET Open (64k+ rules — malware, C2, exploits)
- SSLBL ssl-fp-blacklist (malicious SSL certs)
- SSLBL ja3-fingerprints (malicious TLS fingerprints)
- etnetera/aggressive

**Actively blocked categories** (converted from alert to drop):
trojan-activity, command-and-control, exploit-kit, web-application-attack, attempted-admin, shellcode-detect, successful-admin, successful-recon-limited.

**Fail-closed:** if Suricata crashes, NFQUEUE has no consumer and traffic stops. Auto-restart recovers it quickly.

**Auto-updates:** rules refresh at `RULE_UPDATE_HOUR` (default 3 AM) with live reload (no restart).

### Runtime Enforcement (Tracee)

Tracee monitors containers via eBPF and kills processes that violate policy:

| Event                                     | Action                                   |
| ----------------------------------------- | ---------------------------------------- |
| `ptrace`                                  | SIGKILL — prevents process injection     |
| `setuid` / `setgid`                       | SIGKILL — prevents privilege escalation  |
| `init_module` / `finit_module`            | SIGKILL — prevents kernel module loading |
| `process_vm_writev` / `process_vm_readv`  | SIGKILL — prevents memory hijacking      |
| Package manager execution (apt, pip, npm) | Logged + alerted                         |

### API Proxies

**LLM Proxy** (FastAPI on Distroless Python):

- Reverse-proxies to Anthropic/OpenAI, injecting the real API key
- Supports streaming responses
- Hidden Unicode detection (`GUARD_ENABLED=true`)
- Optional external guard service hook for content scanning

**API Proxy** (nginx+njs on Chainguard):

- Per-service token injection for Telegram, Brave, GitHub, Google, Viber
- Rate limiting (30 req/s general, 5 req/s search)
- Google OAuth2 token auto-rotation every 45 minutes (pure njs, no shell)

Both proxies: read-only filesystem, all capabilities dropped, no-new-privileges, no shell available.

### Alerting

The alerter tails Suricata and Tracee logs and sends:

- **Real-time alerts** to Telegram (severity 1-2 events, rate-limited)
- **Daily traffic summary** at `DAILY_REPORT_HOUR` (default midnight):
  - Top DNS queries
  - Top HTTP/TLS destinations
  - Alert rule trigger counts
  - Blocked packet counts

Without a Telegram bot configured, alerts print to stdout.

### Package Integrity Verification

On build, `pnpm build` generates a SHA256 manifest of all dist files (`.integrity.json`). At gateway startup, the manifest is verified — any tampered or missing files halt startup.

### Hidden Unicode & Prompt Injection Detection

External content (emails, webhooks, web fetches) is scanned for:

- Invisible Unicode characters (zero-width spaces, bidi overrides, invisible operators)
- Prompt injection patterns ("ignore previous instructions", "system:" overrides, etc.)

Enable stripping with `GUARD_STRIP_HIDDEN_UNICODE=true`.

---

## Health Checks

```bash
# OpenClaw gateway
curl http://localhost:18789/health

# LLM proxy
curl http://localhost:10001/health

# API proxy
curl http://localhost:10000/health

# Suricata — verify IPS mode
docker compose -f security/docker-compose.security.yml logs security-suricata | grep "IPS mode"

# Tracee — verify enforcement loaded
docker compose -f security/docker-compose.security.yml logs security-tracee | grep "policy"
```

---

## Development Workflow

### Git Hooks

On `pnpm install`, git hooks are configured automatically (`git config core.hooksPath git-hooks`). The pre-commit hook runs:

1. `oxlint --fix` on staged files
2. `oxfmt --write` on staged files
3. Re-stages the fixed files

### Useful Commands

```bash
pnpm dev             # Dev mode with hot reload
pnpm gateway:dev     # Gateway only (skip channels)
pnpm build           # Full build + integrity manifest
pnpm build:binary    # Single binary via Bun
pnpm test            # Run tests
pnpm check           # Lint + format + typecheck + LOC check
pnpm lint            # oxlint only
pnpm format          # oxfmt only
```

### Max File Length

TypeScript files are limited to 500 lines (`pnpm check:loc`). Split larger files.

---

## Fly.io Deployment

For cloud deployment, `fly.toml` is preconfigured:

```bash
fly deploy
fly secrets set OPENCLAW_GATEWAY_TOKEN=$(openssl rand -hex 32)
fly secrets set ANTHROPIC_API_KEY=sk-ant-...
# ... other secrets
```

Region defaults to `iad`. VM: shared-cpu-2x, 2GB RAM, persistent `/data` volume.

---

## Port Reference

| Service          | Container Port | Host Port | Access from OpenClaw containers  |
| ---------------- | -------------- | --------- | -------------------------------- |
| OpenClaw Gateway | 18789          | 18789     |                                  |
| OpenClaw Bridge  | 18790          | 18790     |                                  |
| LLM Proxy        | 8080           | 10001     | `http://security-llm-proxy:8080` |
| API Proxy Health | 8080           | 10000     | `http://security-api-proxy:8080` |
| Telegram Proxy   | 8081           | —         | `http://security-api-proxy:8081` |
| Brave Proxy      | 8082           | —         | `http://security-api-proxy:8082` |
| GitHub API Proxy | 8083           | —         | `http://security-api-proxy:8083` |
| GitHub Git Proxy | 8084           | —         | `http://security-api-proxy:8084` |
| Google API Proxy | 8085           | —         | `http://security-api-proxy:8085` |
| Viber API Proxy  | 8086           | —         | `http://security-api-proxy:8086` |

---

## Resource Usage

| Service            | ~RAM        |
| ------------------ | ----------- |
| OpenClaw Gateway   | varies      |
| Suricata           | 100 MB      |
| Tracee             | 80 MB       |
| LLM Proxy          | 100 MB      |
| API Proxy          | 20 MB       |
| Alerter            | 10 MB       |
| **Security total** | **~310 MB** |

---

## Troubleshooting

| Problem                         | Solution                                                                             |
| ------------------------------- | ------------------------------------------------------------------------------------ |
| All container traffic blocked   | Suricata may have crashed. Check logs and `docker compose restart security-suricata` |
| Tracee won't start              | Requires Linux kernel 5.4+ with eBPF. Must run privileged with pid:host              |
| No Telegram alerts              | Verify bot token with `curl https://api.telegram.org/bot<TOKEN>/getMe`               |
| Proxy unreachable from OpenClaw | Start OpenClaw first so `openclaw_net` exists. Verify with `docker network ls`       |
| LLM Proxy returns 502           | Check `LLM_API_BASE` and `LLM_API_KEY` in `.env.security`                            |
| Config changes rejected         | Expected in Docker. Config changes go through GitHub PRs (`OPENCLAW_CONFIG_MODE=pr`) |

For detailed security stack troubleshooting, see `security/README.md`.
