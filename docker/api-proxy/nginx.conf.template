events {
    worker_connections 1024;
}

http {
    resolver 8.8.8.8 valid=30s;

    # Port 8080: Anthropic API proxy
    server {
        listen 8080;

        location / {
            proxy_pass https://api.anthropic.com;
            proxy_ssl_server_name on;
            proxy_set_header Host api.anthropic.com;
            proxy_set_header x-api-key ${ANTHROPIC_API_KEY};
            proxy_set_header Content-Type $http_content_type;
            proxy_set_header anthropic-version $http_anthropic_version;
            proxy_set_header anthropic-beta $http_anthropic_beta;
            proxy_buffering off;
        }
    }

    # Port 8081: Telegram API proxy
    server {
        listen 8081;

        # Bot API: /method → /bot<TOKEN>/method
        location / {
            rewrite ^/(.*)$ /bot${TELEGRAM_BOT_TOKEN}/$1 break;
            proxy_pass https://api.telegram.org;
            proxy_ssl_server_name on;
            proxy_set_header Host api.telegram.org;
            proxy_buffering off;
            proxy_read_timeout 300s;
        }

        # File downloads: /file/path → /file/bot<TOKEN>/path
        location /file/ {
            rewrite ^/file/(.*)$ /file/bot${TELEGRAM_BOT_TOKEN}/$1 break;
            proxy_pass https://api.telegram.org;
            proxy_ssl_server_name on;
            proxy_set_header Host api.telegram.org;
        }
    }
}
